<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RN Energy Pro</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --green: #2ea043;
      --red: #f85149;
      --blue: #58a6ff;
      --accent: #f2e000;
      --text: #c9d1d9;
      --gray: #8b949e;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 15px;
      display: flex;
      justify-content: center;
    }

    .container { width: 100%; max-width: 400px; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    h3 { color: var(--accent); margin: 0; font-size: 22px; font-weight: bold; }

    .settings-btn {
      background: #21262d;
      border: 1px solid var(--border);
      color: #c9d1d9;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      margin-top: 15px;
      border: 1px solid var(--border);
    }

    .row { display: flex; justify-content: space-between; }

    .label-top { font-size: 11px; color: var(--gray); text-transform: uppercase; margin-bottom: 5px; }
    .val-main { font-size: 28px; font-weight: 800; }

    /* Tank Styles */
    .tank-section { margin-top: 15px; }
    .tank-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .tank-label { font-size: 12px; color: var(--gray); text-transform: uppercase; }
    .tank-pct { font-size: 16px; font-weight: bold; }
    
    .tank-bar-bg {
      height: 8px;
      background: #21262d;
      border-radius: 10px;
      margin-bottom: 15px;
      overflow: hidden;
    }
    .tank-bar-fill { height: 100%; width: 0%; transition: width 0.5s ease-in-out; }

    /* Control Styles */
    #statusLabel {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: var(--green);
      margin-bottom: 20px;
      text-transform: uppercase;
    }

    .btn-group { display: flex; gap: 15px; }
    .btn-action {
      flex: 1;
      padding: 18px;
      border-radius: 10px;
      border: none;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      color: white;
      text-transform: uppercase;
    }
    .btn-on { background: #1a3d24; color: #2ea043; border: 1px solid #2ea04333; }
    .btn-off { background: var(--red); }

    .btn-reset {
      width: 100%;
      margin-top: 20px;
      padding: 12px;
      background: #161b22;
      border: 1px dashed #484f58;
      color: #f0f6fc;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
  </style>
</head>

<body>
<div class="container">
  <header>
    <h3>RN ENERGY PRO</h3>
    <button class="settings-btn" onclick="openSettings()">⚙️ SETUP</button>
  </header>

  <div class="card">
    <div class="row">
      <div style="flex: 1;">
        <div class="label-top">VOLTAGE</div>
        <div class="val-main" style="color:var(--green)" id="liveV">0V</div>
      </div>
      <div style="flex: 1; text-align: right;">
        <div class="label-top">AMPERE</div>
        <div class="val-main" style="color:var(--blue)" id="liveA">0.000A</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tank-section">
      <div class="tank-info">
        <span class="tank-label">UPPER TANK</span>
        <span class="tank-pct" style="color:var(--blue)" id="upPct">0%</span>
      </div>
      <div class="tank-bar-bg">
        <div id="upBar" class="tank-bar-fill" style="background:var(--blue)"></div>
      </div>

      <div class="tank-info">
        <span class="tank-label">LOWER TANK</span>
        <span class="tank-pct" style="color:var(--accent)" id="loPct">0%</span>
      </div>
      <div class="tank-bar-bg">
        <div id="loBar" class="tank-bar-fill" style="background:var(--accent)"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="statusLabel">WAITING...</div>
    <div class="btn-group">
      <button class="btn-action btn-on" onclick="sendCmd('ON')">MOTOR ON</button>
      <button class="btn-action btn-off" onclick="sendCmd('OFF')">MOTOR OFF</button>
    </div>
    <button class="btn-reset" onclick="resetCloud()">
      ⚠️ RESET CLOUD DATA
    </button>
  </div>
</div>

<script>
  const topicStatus = "A001/STATUS";
  const topicControl = "A001/MOTOR";
  let client;

  function connectMQTT() {
    const user = localStorage.getItem("mqtt_user");
    const pass = localStorage.getItem("mqtt_pass");

    if (!user || !pass) {
      document.getElementById("statusLabel").innerText = "SETUP REQUIRED";
      document.getElementById("statusLabel").style.color = "var(--accent)";
      return;
    }

    client = mqtt.connect(
      "wss://ec91e389d1624d2fa990c2bcb883d331.s1.eu.hivemq.cloud:8884/mqtt",
      { username:user, password:pass }
    );

    client.on("connect", () => {
      document.getElementById("statusLabel").innerText = "CONNECTED";
      client.subscribe(topicStatus);
    });

    client.on("message", (topic, msg) => {
      try {
        const d = JSON.parse(msg.toString());
        // Update Values
        document.getElementById("liveV").innerText = d.v + "V";
        document.getElementById("liveA").innerText = d.a + "A";
        
        // Update Tanks
        document.getElementById("upBar").style.width = d.up + "%";
        document.getElementById("upPct").innerText = d.up + "%";
        document.getElementById("loBar").style.width = d.lo + "%";
        document.getElementById("loPct").innerText = d.lo + "%";

        // Update Status Label (Assuming d.m is motor status)
        if(d.m === "ON") {
            document.getElementById("statusLabel").innerText = "MOTOR RUNNING";
            document.getElementById("statusLabel").style.color = "var(--green)";
        } else {
            document.getElementById("statusLabel").innerText = "MOTOR STOPPED";
            document.getElementById("statusLabel").style.color = "var(--red)";
        }
      } catch (e) { console.log(e); }
    });
  }

  function sendCmd(cmd) {
    if (client && client.connected) client.publish(topicControl, cmd);
  }

  function resetCloud() {
    if (confirm("Are you sure you want to reset cloud data?")) {
      if (client && client.connected) client.publish("A001/RESET", "TRUE");
    }
  }

  function openSettings() {
    const u = prompt("MQTT Username:");
    const p = prompt("MQTT Password:");
    if (u && p) {
      localStorage.setItem("mqtt_user", u);
      localStorage.setItem("mqtt_pass", p);
      location.reload();
    }
  }

  connectMQTT();
</script>
</body>
</html>
