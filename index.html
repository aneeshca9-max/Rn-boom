<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RN Energy ‚Äì Water Motor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body { background: #0b1220; color: #ffffff; font-family: Arial, sans-serif; text-align: center; padding: 30px; }
    h1 { margin-bottom: 20px; font-size: 28px; }
    select, button { width: 240px; padding: 14px; font-size: 18px; margin: 10px; border-radius: 8px; border: none; }
    select { background: #555; color: white; }
    .on { background: #0a8f08; color: white; }
    .off { background: #b30000; color: white; }
    #status { margin-top: 20px; font-size: 18px; }

    /* Modal Styling */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; }
    .modal-content { background:#1a2635; margin:15% auto; padding:20px; width:85%; border-radius:10px; text-align: left; }
    input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; box-sizing: border-box; }
    .settings-btn { position: fixed; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; width: auto; padding: 0; }
  </style>
</head>

<body>

  <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
  <h1>RN Energy ‚Äì Water Motor</h1>

  <select id="device">
    <option value="A001">A001 - Home</option>
    <option value="A002">A002 - Garden</option>
    <option value="A003">A003 - Tank 2</option>
  </select>

  <br>
  <button class="on" onclick="motorOn()">MOTOR ON</button><br>
  <button class="off" onclick="motorOff()">MOTOR OFF</button>

  <div id="status">‚è≥ Loading Settings...</div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-top:0">App Settings</h2>
      <label>MQTT Username:</label>
      <input type="text" id="mqttUser" placeholder="aneesh_home">
      <label>MQTT Password:</label>
      <input type="password" id="mqttPass" placeholder="Your Password">
      
      <button class="on" style="width:100%; margin: 10px 0;" onclick="saveSettings()">SAVE & CONNECT</button>
      <button class="off" style="width:100%; margin: 0;" onclick="closeSettings()">CANCEL</button>
    </div>
  </div>

  <script>
    let client;
    const brokerUrl = "wss://ec91e389d1624d2fa990c2bcb883d331.s1.eu.hivemq.cloud:8884/mqtt";

    // ‡¥Ü‡¥™‡µç‡¥™‡µç ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥ï‡¥£‡¥ï‡µç‡¥ü‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï
    window.onload = function() {
        const savedUser = localStorage.getItem("mqtt_user");
        const savedPass = localStorage.getItem("mqtt_pass");

        if (savedUser && savedPass) {
            connectMQTT(savedUser, savedPass);
        } else {
            document.getElementById("status").innerText = "‚ö†Ô∏è Please set Password in Settings";
            openSettings();
        }
    };

    function connectMQTT(user, pass) {
        document.getElementById("status").innerText = "‚è≥ Connecting...";
        
        const options = {
            username: user,
            password: pass,
            clean: true,
            connectTimeout: 5000,
            reconnectPeriod: 2000
        };

        client = mqtt.connect(brokerUrl, options);

        client.on("connect", () => {
            document.getElementById("status").innerText = "‚úÖ Connected to HiveMQ";
        });

        client.on("reconnect", () => {
            document.getElementById("status").innerText = "üîÑ Reconnecting...";
        });

        client.on("error", (err) => {
            document.getElementById("status").innerText = "‚ùå Auth Failed / Error";
        });
    }

    function motorOn() {
        if(!client || !client.connected) return alert("Not connected!");
        const id = document.getElementById("device").value;
        client.publish(id + "/MOTOR", "ON");
    }

    function motorOff() {
        if(!client || !client.connected) return alert("Not connected!");
        const id = document.getElementById("device").value;
        client.publish(id + "/MOTOR", "OFF");
    }

    // Modal Functions
    function openSettings() {
        document.getElementById("mqttUser").value = localStorage.getItem("mqtt_user") || "aneesh_home";
        document.getElementById("mqttPass").value = localStorage.getItem("mqtt_pass") || "";
        document.getElementById("settingsModal").style.display = "block";
    }

    function closeSettings() {
        document.getElementById("settingsModal").style.display = "none";
    }

    function saveSettings() {
        const user = document.getElementById("mqttUser").value;
        const pass = document.getElementById("mqttPass").value;

        if(user && pass) {
            localStorage.setItem("mqtt_user", user);
            localStorage.setItem("mqtt_pass", pass);
            alert("Settings saved!");
            location.reload();
        } else {
            alert("Please fill all fields");
        }
    }
  </script>

</body>
</html>
